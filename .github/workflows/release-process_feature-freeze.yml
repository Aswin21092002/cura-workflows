name: Feature Freeze
run-name: Feature freeze Cura ${{ inputs.cura_version }} by @${{ github.actor }}

on:
  workflow_call:
    inputs:
      cura_version:
        description: 'Cura version number, e.g. 5.7.2'
        required: true
        type: string

jobs:
  parse-version:
    runs-on: ubuntu-latest
    outputs:
      version_major: ${{ steps.version_parser.outputs.major }}
      version_minor: ${{ steps.version_parser.outputs.minor }}
      version_patch: ${{ steps.version_parser.outputs.patch }}
      branch_name: ${{ steps.version_parser.outputs.major }}.${{ steps.version_parser.outputs.minor }}
    steps:
      - name: Parse version string
        id: version_parser
        uses: booxmedialtd/ws-action-parse-semver@v1.4.7
        with:
          input_string: ${{ inputs.cura_version }}

  feature-freeze:
    runs-on: ubuntu-latest
    needs: [parse-version]
    strategy:
      matrix:
        #repository: [Cura, Uranium, CuraEngine, cura-binary-data, fdm_materials]
        repository: [Cura, cura-binary-data]
    steps:
      - name: Create branch and update conan package version
        run: |
          git clone https://${{ secrets.CURA_AUTORELEASE_PAT }}@github.com/Ultimaker/${{ matrix.repository }}.git
          cd ${{ matrix.repository }}

          git checkout -b ${{ needs.parse-version.outputs.branch_name }}

          PACKAGE_VERSION=${{ needs.parse-version.outputs.version_major }}.${{ needs.parse-version.outputs.version_minor }}.${{ needs.parse-version.outputs.version_patch }}
          sed -i "s/version:.*/version: \"$PACKAGE_VERSION\"/g" conandata.yml

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add conandata.yml
          git commit -m "Set conan package version $PACKAGE_VERSION"
          git push origin `git branch --show-current`
